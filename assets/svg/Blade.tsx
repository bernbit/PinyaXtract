import React, { useState, useEffect } from "react";
import Svg, { G, Path, Ellipse, Defs, ClipPath } from "react-native-svg";
import Animated, {
  useSharedValue,
  useAnimatedProps,
  withRepeat,
  withTiming,
  Easing,
} from "react-native-reanimated";

//Types
import { SVGPropsType } from "@/types/SVG";
import useGlobal from "@/context/GlobalContext";

//! ⚠️ IMPORTANT: Define Animated.createAnimatedComponent(SVGElement) OUTSIDE the Main!
//! If defined inside, it will be re-created on every re-render, causing animations to reset.
const BladeCutter = Animated.createAnimatedComponent(G);

function Blade({ width = 366, height = 366 }: SVGPropsType) {
  const { bladeState, setBladeState, toggleBladeState } = useGlobal();

  const bladeRotation = useSharedValue<number>(0);

  //* useEffect for Fan Animation
  useEffect(() => {
    if (bladeState) {
      bladeRotation.value = 0; // Reset rotation
      bladeRotation.value = withRepeat(
        withTiming(360, { duration: 1000, easing: Easing.linear }),
        -1,
        false,
      );
    } else {
      bladeRotation.value = withTiming(0, { duration: 200 });
    }
  }, [bladeState]);

  const bladeAnimation = useAnimatedProps(() => ({
    transform: [
      { translateX: 182.49 },
      { translateY: 182.475 },
      { rotate: `${bladeRotation.value}deg` },
      { translateX: -182.49 },
      { translateY: -182.475 },
    ],
  }));

  return (
    <Svg
      width={width}
      height={height}
      viewBox="0 0 366 365"
      fill="none"
      // onPress={toggleBladeState}
    >
      <G clipPath="url(#clip0_509_2)">
        <BladeCutter
          animatedProps={bladeAnimation}
          transform="rotate(0, 182.49, 182.475)"
        >
          <Path
            d="M364.074 172.063c-1.083-.57-2.395-.456-3.251.342-3.307 3.023-12.546 9.867-19.276 8.954 0-5.76-.342-11.52-1.027-17.166l15.798-20.988c.513-.57.684-1.368.57-2.167l-4.961-28.002c-.229-1.198-1.141-2.11-2.339-2.281-1.197-.228-2.338.399-2.908 1.425-2.053 3.993-8.498 13.631-15.114 15-1.996-5.532-4.277-10.836-6.843-15.798l7.699-25.094c.228-.741.114-1.54-.285-2.224l-14.144-24.637c-.627-1.027-1.825-1.597-2.966-1.312-1.197.228-2.11 1.14-2.281 2.338-.57 4.449-3.308 15.74-9.068 19.22-3.65-4.278-7.585-8.498-11.805-12.49l-1.369-26.178c0-.798-.399-1.482-.97-1.996l-21.843-18.307a2.834 2.834 0 00-3.25-.228 2.764 2.764 0 00-1.255 3.023c.912 4.334 2.224 15.855-1.939 21.101a143.988 143.988 0 00-15.399-7.756L235.64 12.718c-.285-.684-.913-1.255-1.597-1.54l-26.748-9.695c-1.14-.4-2.395-.057-3.193.912-.742.913-.799 2.225-.172 3.251 2.396 3.764 7.529 14.087 5.418 20.474-5.475-.912-11.064-1.54-17.052-1.939L174.445 5.02c-.513-.628-1.254-.913-2.053-.913h-28.458c-1.255 0-2.282.742-2.681 1.882s0 2.396.913 3.137c3.536 2.68 11.862 10.608 12.204 17.395-5.361.97-10.893 2.28-16.824 3.992l-23.269-11.863c-.684-.342-1.54-.399-2.224-.17L85.305 28.23a2.96 2.96 0 00-1.882 2.737c.057 1.198.856 2.224 1.996 2.623 4.22 1.312 14.772 5.932 17.281 12.148-4.677 2.738-9.41 5.874-14.372 9.467l-26.006-3.194c-.742-.056-1.54.172-2.11.628L38.369 70.947c-.913.798-1.255 2.053-.799 3.137.456 1.14 1.54 1.882 2.738 1.825 4.334-.172 15.968.57 20.474 5.532A145.804 145.804 0 0050.63 95.242l-25.607 5.931a2.717 2.717 0 00-1.825 1.312l-14.2 24.581c-.057.057-.057.114-.114.228-.057.057-.057.114-.114.228-.058.171-.115.399-.058.57a1.882 1.882 0 000 .799c-.057.171 0 .342.058.456.228.627.627 1.198 1.254 1.54.171.114.342.171.514.228.114.057.285.114.456.057.114.114.285.114.399.114.228 0 .456-.057.741-.114.229-.057.457-.171.685-.285 7.072-2.567 15.854-4.164 20.76-1.597-1.883 5.304-3.537 10.836-4.849 16.539L6.716 160.087c-.627.456-1.083 1.083-1.254 1.882L.557 189.971a2.8 2.8 0 001.369 2.966c.456.228.912.342 1.369.342.684 0 1.368-.228 1.882-.742 3.307-2.965 12.603-9.866 19.276-8.896.057 5.874.4 11.634 1.084 17.109L9.682 221.738c-.513.627-.684 1.425-.57 2.224l4.961 28.002c.229 1.198 1.141 2.11 2.339 2.281 1.197.228 2.338-.399 2.908-1.483 2.053-3.878 8.44-13.516 15-14.942a160.309 160.309 0 006.957 15.798l-7.699 25.037c-.228.798-.114 1.597.285 2.224l14.144 24.637c.627 1.084 1.825 1.597 2.966 1.369a2.847 2.847 0 002.28-2.395c.571-4.392 3.309-15.57 9.012-19.106a152.679 152.679 0 0011.862 12.376l1.37 26.235c0 .741.398 1.482.969 1.996l21.843 18.25a2.75 2.75 0 003.25.285 2.765 2.765 0 001.255-3.023c-.912-4.334-2.224-15.855 1.939-21.101a144.043 144.043 0 0015.399 7.756l10.208 24.067a2.659 2.659 0 001.597 1.54l26.748 9.695c.342.114.627.171.969.171.856 0 1.654-.342 2.224-1.026.742-.97.799-2.282.172-3.251-2.396-3.764-7.529-14.087-5.418-20.531 5.532.969 11.121 1.596 16.995 1.996l17.908 19.162a2.757 2.757 0 002.053.913h28.458c1.255 0 2.282-.799 2.681-1.939.399-1.084 0-2.396-.97-3.08-3.479-2.738-11.862-10.665-12.147-17.395 5.361-.969 10.893-2.281 16.824-3.992l23.269 11.863c.684.342 1.539.399 2.224.114l26.748-9.753a2.829 2.829 0 001.882-2.68c-.057-1.198-.856-2.281-1.997-2.623-4.22-1.312-14.771-5.932-17.337-12.148 4.791-2.738 9.524-5.874 14.429-9.524l26.006 3.193c.684.114 1.54-.114 2.11-.627l21.843-18.25c.913-.798 1.255-2.053.799-3.194-.457-1.083-1.711-1.825-2.738-1.768-4.448.171-15.912-.57-20.474-5.532a157.062 157.062 0 0010.209-13.801l25.55-5.931a2.72 2.72 0 001.825-1.312l14.143-24.581c.057-.057.114-.057.057-.114.114-.171.171-.399.228-.57.229-.456.229-.97 0-1.426-.057-.228-.114-.456-.228-.627-.057-.228-.228-.456-.456-.627v-.058c-.171-.171-.342-.342-.57-.399-.228-.171-.456-.228-.742-.285a2.05 2.05 0 00-.627-.114c-.399 0-.855.057-1.198.228a.432.432 0 00-.228.114c-7.072 2.567-15.797 4.164-20.702 1.654 1.882-5.475 3.536-11.007 4.79-16.539l22.015-14.258a3.27 3.27 0 001.254-1.882l4.905-28.059c.228-1.141-.342-2.338-1.369-2.909zm-125.354 9.41c0 30.626-24.923 55.492-55.492 55.492s-55.491-24.866-55.491-55.492c0-30.568 24.922-55.434 55.491-55.434s55.492 24.866 55.492 55.434z"
            fill="#30F353"
          />
          <Ellipse cx={183} cy={182.5} rx={65} ry={64.5} fill="#2B2B2B" />
        </BladeCutter>
      </G>
      <Defs>
        <ClipPath id="clip0_509_2">
          <Path fill="#fff" transform="translate(.5)" d="M0 0H365V365H0z" />
        </ClipPath>
      </Defs>
    </Svg>
  );
}

export default Blade;
